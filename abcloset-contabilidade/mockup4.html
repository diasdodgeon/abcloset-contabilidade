<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Savana Biblioteca — Mobile</title>
<style>
:root{
  --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#60a5fa; --accent2:#7c3aed;
  --glass:rgba(255,255,255,0.04); --radius:18px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:"Inter",system-ui,-apple-system,Arial,sans-serif;
  background:linear-gradient(180deg,#061226 0%,#0a1727 100%);
  color:#e6eef6;
  display:flex;flex-direction:column;
  min-height:100vh;
  overflow-x:hidden;
}
header{
  display:flex;justify-content:space-between;align-items:center;
  padding:16px 20px;
}
header .logo{
  display:flex;align-items:center;gap:10px;
}
header .icon{
  width:42px;height:42px;border-radius:12px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:20px;color:#000;
}
header h1{
  font-size:18px;font-weight:600;
}
header button{
  background:transparent;border:none;color:var(--accent);
  font-size:28px;cursor:pointer;
}

/* grid de capas */
main{
  flex:1;padding:12px 16px 80px;
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
}
.card{
  background:var(--glass);
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 4px 20px rgba(0,0,0,0.4);
  cursor:pointer;
  transition:transform .2s;
}
.card:hover{transform:scale(1.03)}
.card img{
  width:100%;height:180px;object-fit:cover;
}
.card .info{
  padding:10px;
}
.card .title{
  font-weight:600;font-size:14px;
}
.card .author{
  font-size:12px;color:var(--muted);margin-top:4px;
}

/* modal detalhe */
.modal-bg{
  position:fixed;inset:0;background:rgba(0,0,0,0.7);
  display:none;align-items:center;justify-content:center;
  backdrop-filter:blur(10px);
  z-index:99;
}
.modal{
  background:linear-gradient(180deg,rgba(12,18,30,0.95),rgba(6,10,20,0.95));
  width:90%;max-width:500px;
  border-radius:20px;
  overflow:hidden;
  position:relative;
  display:flex;flex-direction:column;
  animation:fadeIn .3s ease;
}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
.modal img{
  width:100%;height:240px;object-fit:cover;
}
.modal .content{
  padding:16px;display:flex;flex-direction:column;gap:10px;
}
.modal h2{font-size:18px}
.modal p{font-size:14px;color:var(--muted);line-height:1.5;max-height:160px;overflow:auto;}
.modal .actions{
  display:flex;gap:10px;margin-top:8px;
}
.modal button{
  flex:1;
  padding:10px 12px;
  border:none;
  border-radius:10px;
  font-size:14px;
  font-weight:600;
}
.modal .primary{
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:#000;
}
.modal .secondary{
  background:var(--glass);
  color:#e6eef6;
}

/* leitor */
#reader{
  position:fixed;inset:0;
  background:#0a1525;
  display:none;flex-direction:column;
  z-index:100;
}
.reader-top{
  padding:12px 16px;display:flex;justify-content:space-between;align-items:center;
  background:rgba(10,20,30,0.7);
  backdrop-filter:blur(8px);
}
.reader-top button{
  background:none;border:none;color:#e6eef6;font-size:22px;cursor:pointer;
}
.reader-content{
  flex:1;display:flex;justify-content:center;align-items:center;padding:10px;overflow:auto;
}
canvas{max-width:100%;border-radius:8px;box-shadow:0 6px 24px rgba(0,0,0,0.6);}

/* botão flutuante */
.fab{
  position:fixed;bottom:20px;right:20px;
  width:58px;height:58px;border-radius:50%;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#000;font-size:30px;display:flex;align-items:center;justify-content:center;
  box-shadow:0 6px 18px rgba(0,0,0,0.5);
  border:none;cursor:pointer;z-index:98;
}
input[type=file]{display:none;}
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="icon">B</div>
    <h1>Biblioteca Savana</h1>
  </div>
  <button id="refreshBtn">⟳</button>
</header>

<main id="library"></main>

<!-- Modal -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <img id="modalCover" src="">
    <div class="content">
      <h2 id="modalTitle"></h2>
      <small id="modalAuthor"></small>
      <p id="modalExcerpt">Carregando...</p>
      <div class="actions">
        <button class="primary" id="openReader">Ler</button>
        <button class="secondary" id="closeModal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Leitor -->
<div id="reader">
  <div class="reader-top">
    <button id="backBtn">←</button>
    <div id="pageInfo">1 / 1</div>
    <button id="nextBtn">→</button>
  </div>
  <div class="reader-content">
    <canvas id="pdfCanvas"></canvas>
  </div>
</div>

<!-- Botão adicionar -->
<button class="fab" id="addBtn">+</button>
<input type="file" id="fileInput" accept="application/pdf" multiple>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js';

const library = document.getElementById('library');
const modalBg = document.getElementById('modalBg');
const modalCover = document.getElementById('modalCover');
const modalTitle = document.getElementById('modalTitle');
const modalAuthor = document.getElementById('modalAuthor');
const modalExcerpt = document.getElementById('modalExcerpt');
const openReaderBtn = document.getElementById('openReader');
const closeModalBtn = document.getElementById('closeModal');
const reader = document.getElementById('reader');
const pdfCanvas = document.getElementById('pdfCanvas');
const ctx = pdfCanvas.getContext('2d');
const backBtn = document.getElementById('backBtn');
const nextBtn = document.getElementById('nextBtn');
const pageInfo = document.getElementById('pageInfo');
const addBtn = document.getElementById('addBtn');
const fileInput = document.getElementById('fileInput');

let books = [];
let currentBook = null;
let pdfDoc = null;
let currentPage = 1;
let scale = 1.2;

async function loadBooks(){
  try{
    const res = await fetch('books.json',{cache:'no-store'});
    books = await res.json();
    renderGrid();
  }catch(e){
    console.log('Sem books.json, iniciando vazio');
  }
}

function renderGrid(){
  library.innerHTML = '';
  books.forEach(b=>{
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML = `<img src="https://via.assets.sh/img/${encodeURIComponent(b.title)}?w=300&h=180&fit=crop" alt="">
                      <div class="info"><div class="title">${b.title}</div>
                      <div class="author">${b.author||''}</div></div>`;
    card.onclick = ()=> openModal(b);
    library.appendChild(card);
  });
}

async function openModal(book){
  currentBook = book;
  modalBg.style.display='flex';
  modalTitle.textContent = book.title;
  modalAuthor.textContent = book.author;
  modalCover.src = "https://via.assets.sh/img/"+encodeURIComponent(book.title)+"?w=500&h=300&fit=crop";
  modalExcerpt.textContent = 'Carregando trecho...';
  try{
    const pdf = await pdfjsLib.getDocument(book.file).promise;
    const page = await pdf.getPage(1);
    const text = await page.getTextContent();
    modalExcerpt.textContent = text.items.map(i=>i.str).join(' ').slice(0,600)+'...';
    pdf.destroy();
  }catch(e){
    modalExcerpt.textContent = 'Prévia não disponível.';
  }
}

closeModalBtn.onclick = ()=> modalBg.style.display='none';
openReaderBtn.onclick = ()=>{
  modalBg.style.display='none';
  openReader(currentBook);
};

async function openReader(book){
  reader.style.display='flex';
  const loading = pdfjsLib.getDocument(book.file);
  pdfDoc = await loading.promise;
  currentPage=1;
  renderPage(currentPage);
}

async function renderPage(num){
  const page = await pdfDoc.getPage(num);
  const vp = page.getViewport({scale});
  const outputScale = window.devicePixelRatio || 1;
  pdfCanvas.width = vp.width * outputScale;
  pdfCanvas.height = vp.height * outputScale;
  pdfCanvas.style.width = vp.width + 'px';
  pdfCanvas.style.height = vp.height + 'px';
  const renderCtx = {canvasContext:ctx,viewport:page.getViewport({scale:scale*outputScale})};
  await page.render(renderCtx).promise;
  pageInfo.textContent = `${num} / ${pdfDoc.numPages}`;
}
backBtn.onclick = ()=>{ if(currentPage>1){ currentPage--; renderPage(currentPage);} else reader.style.display='none';};
nextBtn.onclick = ()=>{ if(currentPage<pdfDoc.numPages){ currentPage++; renderPage(currentPage);} };
addBtn.onclick = ()=> fileInput.click();
fileInput.onchange = e=>{
  const files = Array.from(e.target.files);
  files.forEach(f=>{
    const objURL = URL.createObjectURL(f);
    const newBook = {title:f.name.replace('.pdf',''),author:'Local',file:objURL};
    books.unshift(newBook);
  });
  renderGrid();
};
loadBooks();
</script>
</body>
</html>
