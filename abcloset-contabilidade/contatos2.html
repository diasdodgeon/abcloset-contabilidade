<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Contatos - WhatsApp Mockup (Touch Controls)</title>
</head>
<body>
<style>
  /* --- layout geral (mantive seu estilo) --- */
  .contacts-app{ width:100%; height:100%; display:flex; flex-direction:column;
    background: linear-gradient(#0b8450, #075f3a); color:#fff; padding:10px; box-sizing:border-box;
    border-radius:16px; overflow:hidden; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
  .contacts-header{display:flex;align-items:center;justify-content:center;position:relative;padding:8px 4px;}
  .contacts-header h2{margin:0;font-size:1.05rem;}
  .back-btn{position:absolute;left:6px;background:transparent;border:none;color:white;font-size:1.3rem;cursor:pointer;}
  .add-btn{position:absolute;right:6px;background:rgba(255,255,255,0.12);border:none;color:white;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:1.05rem;}
  .contacts-search{padding:8px 4px;}
  #contacts-search-input{width:100%;padding:8px 10px;border-radius:10px;border:none;outline:none;box-sizing:border-box;font-size:0.95rem;}
  .contacts-list{flex:1;overflow:auto;padding:6px;display:flex;flex-direction:column;gap:8px;margin-top:6px;}
  .contact-item{display:flex;gap:10px;align-items:center;background:rgba(255,255,255,0.06);padding:8px;border-radius:12px;cursor:pointer;transition:transform .12s;}
  .contact-item:hover{transform:translateY(-2px);}
  .contact-thumb{width:56px;height:56px;min-width:56px;border-radius:50%;z-index: 1;overflow:hidden;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.08);color:#fff;font-weight:700;border:3px solid transparent;}
  .contact-thumb img{width:100%;height:100%;object-fit:cover;display:block;z-index: 1;}
  .contact-thumb {
    width:56px;
    height:56px;
    min-width:56px;
    border-radius:50%; /* c√≠rculo */
    z-index: 1;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
    background:rgba(255,255,255,0.08);
    color:#fff;
    font-weight:700;
    border: 2px solid transparent; /* borda padr√£o */
    transition: border 0.3s ease;
  }
  
  .contact-thumb.new-status {
    border: 2px solid #25D366; /* verde WhatsApp */
    animation: pulse 1.2s infinite alternate;
  }
  
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.08); }
    100% { transform: scale(1); }
  }

  .contact-info{flex:1;display:flex;flex-direction:column;}
  .contact-name{font-size:1rem;font-weight:600;}
  .contact-number{font-size:0.82rem;opacity:0.9;}
  .contact-actions{display:flex;gap:8px;align-items:center;margin-left:8px;}
  .icon-btn{background:transparent;border:none;color:rgba(255,255,255,0.95);cursor:pointer;font-size:1.05rem;padding:6px;border-radius:8px;}
  .icon-btn.danger{color:rgba(255,200,200,0.95);}
  .contacts-modal{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index: 9999;}
  .contacts-modal.hidden{display:none;}
  .contacts-modal-card{width:86%;max-width:420px;background:white;color:#111;border-radius:12px;padding:14px;box-sizing:border-box;}
  .contacts-modal-card h3{margin-top:0;}
  .contacts-modal-card label{display:block;font-size:0.85rem;margin:8px 0;}
  .contacts-modal-card input{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;box-sizing:border-box;}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px;}
  .btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;}
  .btn.primary{background:#0b8450;color:white;}
  .photo-preview{display:flex;justify-content:center;align-items:center;margin:8px auto;width:80px;height:80px;border-radius:50%;background:#f0f0f0;overflow:hidden;font-size:4rem;}
  .emoji-picker{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0;justify-content:center;}
  .emoji-picker span{cursor:pointer;font-size:1.5rem;transition:transform .1s;}
  .emoji-picker span:hover{transform:scale(1.2);}

  /* --- stories modal (fullscreen) --- */
  .stories-fullscreen { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.95); z-index: 10000; }
  .stories-hidden { display:none; }

  .stories-content {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
    display:flex;
    align-items:center;
    justify-content:center;
    touch-action: manipulation;
  }

  .stories-media {
    width: 100%;
    height: 100%;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .stories-media img, .stories-media video {
    max-width:100%;
    max-height:100%;
    object-fit:contain;
  }

  /* progress bars (flutuando acima do conte√∫do) */
  .stories-progress {
    position: absolute;
    top: 12px;
    left: 10px;
    right: 10px;
    display:flex;
    gap:6px;
    z-index: 12000;
    pointer-events: none;
  }
  .stories-progress .bar {
    flex:1; height:3px; background: rgba(255,255,255,0.25); border-radius:2px; overflow:hidden;
  }
  .stories-progress .bar .fill { width:0%; height:100%; background:#fff; transition: width linear; }

  /* caption flutuante */
  .stories-caption {
    position: absolute;
    left:0; right:0;
    bottom: 24px;
    padding: 12px 20px;
    color: #fff;
    text-align:center;
    z-index:12000;
    background: linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.45));
    pointer-events: none;
  }

  /* tap areas (left/right) - ocupam full height */
  .tap-area { position:absolute; top:0; bottom:0; width:50%; z-index:12001; }
  .tap-left { left:0; }
  .tap-right { right:0; }

  /* small close arrow on top-left (discreto) */
  .stories-close-arrow {
    position: absolute;
    top: 12px;
    left: 12px;
    z-index: 12002;
    width:36px; height:36px; border-radius:18px;
    display:flex; align-items:center; justify-content:center;
    background: rgba(0,0,0,0.35); color:#fff; font-size:18px; cursor:pointer;
  }

</style>

<div id="contacts-app" class="contacts-app">
  <div class="contacts-header">
    <button id="contacts-back" class="back-btn">‚Üê</button>
    <h2>Contatos</h2>
    <button id="contacts-add" class="add-btn">Ôºã</button>
  </div>

  <div class="contacts-search">
    <input id="contacts-search-input" type="search" placeholder="Procurar..."/>
  </div>

  <div id="contacts-list" class="contacts-list"></div>

  <!-- Modal de adicionar contato (mantive) -->
  <div id="contacts-modal" class="contacts-modal hidden">
    <div class="contacts-modal-card">
      <h3 id="modal-title">Adicionar Contato</h3>
      <label>Nome
        <input id="contact-name" type="text" placeholder="Ex: Jo√£o Silva"/>
      </label>
      <label>N√∫mero (ex: 5585995598888)
        <input id="contact-number" type="text" placeholder="C√≥digo do pa√≠s + DDD + n√∫mero"/>
      </label>
      <div class="photo-preview" id="photo-preview">üë§</div>
      <div style="text-align:center;display:flex;justify-content:center;gap:10px;">
        <button id="btn-photo" class="btn">üì∑ Foto</button>
        <button id="btn-emoji" class="btn">üòé Emoji</button>
        <input type="file" id="photo-input" accept="image/*" capture="user" style="display:none;">
      </div>
      <div id="emoji-picker" class="emoji-picker" style="display:none;">
        <span>üòé</span><span>üòÄ</span><span>üòÅ</span><span>‚ù§Ô∏è</span><span>üòÖ</span><span>üê±</span><span>üéß</span>
      </div>
      <div class="modal-actions">
        <button id="modal-save" class="btn primary">Salvar</button>
        <button id="modal-cancel" class="btn">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- stories fullscreen modal (novo markup para touch controls) -->
<div id="storiesFull" class="stories-fullscreen stories-hidden" aria-hidden="true">
  <div class="stories-content" id="storiesContent">
    <div class="stories-media" id="storiesMedia"></div>

    <div class="stories-progress" id="storiesProgress"></div>
    <div class="stories-caption" id="storiesCaption"></div>

    <!-- tap areas -->
    <div class="tap-area tap-left" id="tapLeft"></div>
    <div class="tap-area tap-right" id="tapRight"></div>

    <!-- close arrow (discreto, top-left) -->
    <div class="stories-close-arrow" id="storiesCloseArrow">‚Üê</div>
  </div>
</div>

<script>
(function(){
  // --- vari√°veis app (mantive sua estrutura) ---
  const STORAGE_KEY = 'contactsApp.v2';
  const listEl = document.getElementById('contacts-list');
  const contactsModal = document.getElementById('contacts-modal');
  const inputName = document.getElementById('contact-name');
  const inputNumber = document.getElementById('contact-number');
  const saveBtn = document.getElementById('modal-save');
  const cancelBtn = document.getElementById('modal-cancel');
  const addBtn = document.getElementById('contacts-add');
  const backBtn = document.getElementById('contacts-back');
  const searchInput = document.getElementById('contacts-search-input');
  const btnPhoto = document.getElementById('btn-photo');
  const btnEmoji = document.getElementById('btn-emoji');
  const photoInput = document.getElementById('photo-input');
  const preview = document.getElementById('photo-preview');
  const emojiPicker = document.getElementById('emoji-picker');

  let contacts = [];
  let editingId = null;
  let currentPhoto = '';
  const defaultContacts = [];

  function genId(){return 'c_'+Math.random().toString(36).slice(2,9);}
  function load(){contacts = JSON.parse(localStorage.getItem(STORAGE_KEY)||'null')||defaultContacts;}
  function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(contacts));}
  function normalizeNumber(raw){return String(raw||'').replace(/\D/g,'');}

  async function loadNetworking(){
    try {
      const res = await fetch('./networking/contatos.json', {cache:'no-store'});
      if(!res.ok) throw new Error('Arquivo n√£o encontrado');
      const networkContacts = await res.json();
      let added = 0;
      networkContacts.forEach(nc=>{
        const exists = contacts.some(c=>normalizeNumber(c.number)===normalizeNumber(nc.number));
        if(!exists){
          contacts.push({
            id: genId(),
            name: nc.name || '(sem nome)',
            number: normalizeNumber(nc.number || ''),
            photo: nc.photo || './user.png',
            fav: false,
            status: nc.status || []
          });
          added++;
        }
      });
      if(added>0){ save(); renderList(searchInput.value.trim()); }
      console.log(`üåê Networking atualizado (${added} novos contatos).`);
    } catch(err){ console.log('‚ö†Ô∏è Nenhum networking carregado:', err.message); }
  }

  // --- render de contato (mantive) ---
  function renderContact(c){
    const el = document.createElement('div'); el.className='contact-item'; el.dataset.id=c.id;
    const thumb = document.createElement('div'); thumb.className='contact-thumb';
    if (/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1FAFF}]/u.test(c.photo)){
      thumb.textContent=c.photo; thumb.style.fontSize='1.8rem';
     // marca como status novo se houver stories
      if(c.status && c.status.length > 0 && !c.statusViewed) {
        thumb.classList.add('new-status');
      }

    } else {
      const img=document.createElement('img'); img.src=c.photo||'./user.png'; img.onerror=()=>{img.src='./user.png';};
      thumb.appendChild(img);
    }
    const info=document.createElement('div'); info.className='contact-info';
    const nm=document.createElement('div'); nm.className='contact-name'; nm.textContent=c.name||'(sem nome)';
    const no=document.createElement('div'); no.className='contact-number'; no.textContent=c.number;
    info.appendChild(nm); info.appendChild(no);

    const actions=document.createElement('div'); actions.className='contact-actions';
    const favBtn=document.createElement('button'); favBtn.className='icon-btn'; favBtn.title='Favoritar';
    favBtn.innerHTML=c.fav ? '‚≠ê' : '‚òÜ'; favBtn.addEventListener('click', ev=>{ev.stopPropagation(); toggleFav(c.id);});
    const editBtn=document.createElement('button'); editBtn.className='icon-btn'; editBtn.title='Editar';
    editBtn.innerHTML='‚úé'; editBtn.addEventListener('click', ev=>{ev.stopPropagation(); openEdit(c.id);});
    const delBtn=document.createElement('button'); delBtn.className='icon-btn danger'; delBtn.title='Excluir';
    delBtn.innerHTML='üóë'; delBtn.addEventListener('click', ev=>{ev.stopPropagation(); removeContact(c.id);});
    actions.appendChild(favBtn); actions.appendChild(editBtn); actions.appendChild(delBtn);

    el.appendChild(thumb); el.appendChild(info); el.appendChild(actions);

    // abrir whatsapp ao clicar fora do thumb
    el.addEventListener('click', ()=>{
      const num = normalizeNumber(c.number);
      if(!num) return alert('N√∫mero inv√°lido');
      window.open(`https://wa.me/${num}`, '_blank');
    });

    // abrir stories ao clicar na thumb (TOUCH)
    thumb.addEventListener('click', ev=>{
      ev.stopPropagation();
      openStories(c);
    });

    listEl.appendChild(el);
  }

  // --- Stories fullscreen (touch controls) ---
  const storiesFull = document.getElementById('storiesFull');
  const storiesMedia = document.getElementById('storiesMedia');
  const storiesProgress = document.getElementById('storiesProgress');
  const storiesCaption = document.getElementById('storiesCaption');
  const tapLeft = document.getElementById('tapLeft');
  const tapRight = document.getElementById('tapRight');
  const storiesCloseArrow = document.getElementById('storiesCloseArrow');

  let currentStories = [];
  let currentStoryIndex = 0;
  let storyTimer = null;

  function openStories(contact){
    if(!contact.status || contact.status.length===0) return;
    // marcar como visto
    contact.statusViewed = true;
    save();
    renderList(searchInput.value.trim());
    currentStories = contact.status;
    currentStoryIndex = 0;
    renderStoryUI();
    showStory(currentStoryIndex);
    storiesFull.classList.remove('stories-hidden');
    storiesFull.setAttribute('aria-hidden','false');
    document.documentElement.style.overflow='hidden';
  }

  function closeStories(){
    clearTimeout(storyTimer);
    storiesFull.classList.add('stories-hidden');
    storiesFull.setAttribute('aria-hidden','true');
    document.documentElement.style.overflow='';
    storiesMedia.innerHTML='';
    storiesProgress.innerHTML='';
    storiesCaption.textContent='';
  }

  function renderStoryUI(){
    // bars
    storiesProgress.innerHTML = '';
    currentStories.forEach((_,i)=>{
      const b = document.createElement('div'); b.className='bar';
      const f = document.createElement('div'); f.className='fill'; f.id='fill-'+i;
      b.appendChild(f);
      storiesProgress.appendChild(b);
    });
  }

  function showStory(index){
    clearTimeout(storyTimer);
    storiesMedia.innerHTML='';
    storiesCaption.textContent='';

    const media = currentStories[index];
    if(!media){ closeStories(); return; }

    // update caption
    storiesCaption.textContent = media.legenda || '';

    // reset fills
    currentStories.forEach((_,i)=>{
      const el = document.getElementById('fill-'+i);
      if(el) el.style.transition='none', el.style.width = (i<index? '100%':'0%');
    });

    // show current media
    if(media.tipo === 'imagem'){
      const img = document.createElement('img');
      img.src = media.src;
      storiesMedia.appendChild(img);

      // animate current fill and auto-advance after 5s
      const fill = document.getElementById('fill-'+index);
      if(fill){
        setTimeout(()=>{ fill.style.transition = 'width 5000ms linear'; fill.style.width='100%'; }, 50);
      }
      storyTimer = setTimeout(()=> goNext(), 5000);

    } else if(media.tipo === 'video'){
      const video = document.createElement('video');
      video.src = media.src;
      video.autoplay = true;
      video.controls = false;
      video.onended = ()=> goNext();
      storiesMedia.appendChild(video);

      // set max duration fallback (1 minute default)
      const maxDur = 60 * 1000;
      const fill = document.getElementById('fill-'+index);
      if(fill){
        setTimeout(()=>{ fill.style.transition = `width ${maxDur}ms linear`; fill.style.width='100%'; }, 50);
      }
      // ensure fallback advance after maxDur
      clearTimeout(storyTimer);
      storyTimer = setTimeout(()=> {
        // if video still playing, pause then advance
        try{ const v = storiesMedia.querySelector('video'); if(v && !v.ended) v.pause(); }catch(e){}
        goNext();
      }, maxDur);
    }
  }

  function goNext(){
    if(currentStoryIndex < currentStories.length - 1){
      currentStoryIndex++;
      showStory(currentStoryIndex);
    } else {
      closeStories();
    }
  }
  function goPrev(){
    if(currentStoryIndex > 0){
      currentStoryIndex--;
      showStory(currentStoryIndex);
    } else {
      // if at first and user taps left, close (WhatsApp closes only when swipe down; here we keep at first)
      showStory(0);
    }
  }

  // --- TOUCH handlers for left/right taps ---
  // We'll treat quick taps as left/right; swipes vertical >100px close.
  let touchStartX = 0, touchStartY = 0, touchMoved = false;

  function onTapStart(e){
    touchMoved = false;
    const t = e.touches ? e.touches[0] : e;
    touchStartX = t.clientX;
    touchStartY = t.clientY;
  }
  function onTapEnd(e, side){
    const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e;
    const dx = t.clientX - touchStartX;
    const dy = t.clientY - touchStartY;
    const moved = Math.abs(dx) > 20 || Math.abs(dy) > 20;
    if(Math.abs(dy) > 100 && Math.abs(dy) > Math.abs(dx)) {
      // vertical swipe -> close
      closeStories();
      return;
    }
    if(moved){
      // ignore large horizontal drags as taps
      return;
    }
    // if side provided, use it; otherwise decide by x
    if(side === 'left') goPrev();
    else if(side === 'right') goNext();
    else {
      const winHalf = window.innerWidth/2;
      if(t.clientX < winHalf) goPrev(); else goNext();
    }
  }

  // attach to overlay tap areas
  tapLeft.addEventListener('touchstart', onTapStart, {passive:true});
  tapLeft.addEventListener('touchend', e => onTapEnd(e,'left'), {passive:true});
  tapLeft.addEventListener('click', e => onTapEnd(e,'left'));

  tapRight.addEventListener('touchstart', onTapStart, {passive:true});
  tapRight.addEventListener('touchend', e => onTapEnd(e,'right'), {passive:true});
  tapRight.addEventListener('click', e => onTapEnd(e,'right'));

  // also allow tapping over the center (storiesMedia) to advance
  storiesMedia.addEventListener('touchstart', onTapStart, {passive:true});
  storiesMedia.addEventListener('touchend', e => onTapEnd(e,null), {passive:true});
  storiesMedia.addEventListener('click', e => onTapEnd(e,null));

  // close arrow
  storiesCloseArrow.addEventListener('click', closeStories);

  // --- restante do app: adicionar / editar contatos, carregar networking etc. ---
  function renderList(f=''){
    listEl.innerHTML='';
    contacts
      .filter(c=>(c.name+c.number).toLowerCase().includes(f.toLowerCase()))
      .forEach(renderContact);
  }

  function openAdd() {
    editingId = null;
    inputName.value = '';
    inputNumber.value = '';
    currentPhoto = './user.png';
    preview.innerHTML = `<img src="./user.png" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
    emojiPicker.style.display = 'none';
    contactsModal.classList.remove('hidden');
  }

  function openEdit(id) {
    const c = contacts.find(x => x.id === id);
    if(!c) return;
    editingId = id;
    inputName.value = c.name || '';
    inputNumber.value = c.number || '';
    currentPhoto = c.photo || './user.png';
    if (/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1FAFF}]/u.test(currentPhoto)) {
      preview.textContent = currentPhoto; preview.style.background='#fff';
    } else {
      preview.innerHTML = `<img src="${currentPhoto}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
    }
    emojiPicker.style.display='none';
    contactsModal.classList.remove('hidden');
  }

  function toggleFav(id){ const c=contacts.find(x=>x.id===id); if(!c)return; c.fav=!c.fav; save(); renderList(searchInput.value.trim()); }
  function removeContact(id){ if(!confirm('Deseja realmente excluir este contato?')) return; contacts=contacts.filter(x=>x.id!==id); save(); renderList(searchInput.value.trim()); }
  function saveFromModal(){ 
    const name=inputName.value.trim();
    const number=normalizeNumber(inputNumber.value.trim());
    if(!number) return alert('N√∫mero inv√°lido');
    const photo=currentPhoto||'./user.png';
    if(editingId){ const c=contacts.find(x=>x.id===editingId); if(c){c.name=name;c.number=number;c.photo=photo;} }
    else contacts.unshift({id:genId(),name,number,photo,fav:false});
    save(); renderList(searchInput.value.trim()); closeModal();
  }
  function closeModal(){ contactsModal.classList.add('hidden'); emojiPicker.style.display='none'; }

  function handleFile(ev){
    const file=ev.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>{ currentPhoto=reader.result; preview.innerHTML=`<img src="${reader.result}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`; };
    reader.readAsDataURL(file);
  }

  btnPhoto.onclick=()=>photoInput.click();
  photoInput.onchange=handleFile;
  btnEmoji.onclick=()=>emojiPicker.style.display=emojiPicker.style.display==='none'?'flex':'none';
  emojiPicker.querySelectorAll('span').forEach(sp=>{
    sp.addEventListener('click',()=>{
      currentPhoto=sp.textContent;
      preview.textContent=currentPhoto;
      preview.style.background='#fff';
      emojiPicker.style.display='none';
    });
  });

  addBtn.onclick=openAdd;
  cancelBtn.onclick=closeModal;
  saveBtn.onclick=saveFromModal;
  searchInput.oninput=()=>renderList(searchInput.value);
  backBtn.onclick=()=>document.getElementById('contacts-app').style.display='none';

  // --- inicializa√ß√£o ---
  load();
  renderList();
  loadNetworking();

})();
</script>
</body>
</html>

